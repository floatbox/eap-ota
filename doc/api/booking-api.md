## Версия v1.4

### Назначение API

Позволяет партнерам создавать и оплачивать заказы (бронирование авиабилетов)
на eviterra.com. Оплаченные бронирования будут выписаны автоматически или вручную.

### Примерный процесс использования

участники:

* Приложение партнера ("движок" сайта, десктопное/мобильное приложение и т.п.)
* Пользователь приложения
* API (сервер eviterra.com)

процесс:

* Поиск
  * Пользователь вводит количество пассажиров, даты и точки назначения.
  * Приложение передает в API поиска вариантов (api/v1/variants.xml) эти данные.
  * API возвращает варианты перелетов с данными рейсов и ценами.
* Создание заказа
  * Пользователь выбирает устраивающий его вариант.
  * Приложение передает в API идентификатор варианта (recommendation), и количество пассажиров.
  * API проверяет наличие мест на рейсах, создает заказ, и возвращает цену и URL заказа.
* Бронирование
  * Пользователь вводит данные пассажиров и контактные данные покупателя (требуются для авикомпаний)
  * Приложение передает в API
  * API создает бронирование, и возвращает номер бронирования и уточненную цену.
* Оплата
  * Приложение передает в API тип платежа, сумму, и данные
  * API проверяет что текущая стоимость совпадает с переданной суммой и осуществляет платеж.
* Выписка
  * Оплаченные бронирования обилечиваются автоматически или вручную, в порядке очереди.
  * Состояние заказа и номера билетов приложение может периодически запрашивать у API.
* Данные заказа
  * в разработке
* Отмена и частичный возврат
  * в разработке

Шаги "бронирование" и "оплата" могут быть совмещены в единый запрос.

### Авторизация

HTTP Basic. Для тестовых заказов пока не нужна.

## Создание заказа

Создает новый заказ, при наличии мест на запрошенных рейсах. Возвращает стоимость.

### Запрос

**URL**

*  https://api.eviterra.com/v1/orders - production доступ

*  https://api-demo.eviterra.com/v1/orders - тестовый доступ

**Method** POST

**Content-type** `application/json` или `application/x-www-form-urlencoded`

### Параметры

name             | required or default  | description | example
-----------------|----------------------|-------------|--------
`recommendation` | *                    | `recommendation` из ответа api/v1/variants.xml  | amadeus.LO.SS.MM.88.LO678SVOWAW151212-LO335WAWCDG161212
`adults`         | `1`                  | полных тарифов
`children`       | `0`                  | детских тарифов с местом (до 12 лет)
`infants`        | `0`                  | детских тарифов без места (до 2 лет)

### Успешный ответ

**Status** 200 Ok

**Content-type** `application/json`

JSON path             |  description
----------------------|-------------
`success`             |  true/false, успешность операции
`order.id`            |  id заказа
`order.link`          |  URL для отправки запроса на бронирование и оплату.
`order.prices.total`  |  полная стоимость заказа, в рублях.
`order.rules`         |  правила тарифа


## Бронирование и оплата

**URL** `order.link` из ответа на предыдущий запрос.

**Method** POST

**Content-type** `application/json` или `application/x-www-form-urlencoded`

### Параметры

name                                      | required | description               | example
------------------------------------------|----------|---------------------------|--------
`order[email]`                            | *        | email покупателя          | test@example.com
`order[phone]`                            | *        | телефон покупателя        | +79998887766
`order[persons][0][last_name]`            | *        | фамилия первого пассажира | Ivanov
`order[persons][0][first_name]`           | *        | имя                       | Alexey
`order[persons][0][sex]`                  | *        | пол, m / f                | m
`order[persons][0][birthday]`             | *        |                           | 1980-12-20
`order[persons][0][nationality_code]`     | *        | ISO 3166-1 alpha-3        | RUS
`order[persons][0][passport]`             | *        |                           | 1232323232
`order[persons][0][document_expiration]`  |          |                           | 2020-12-30
`order[persons][1][last_name]`            |          | фамилия второго пассажира |
...                                       |
`order[payment_type]`                     | *        | метод оплаты              | cash

### Ответ

**Status** 200 Ok

**Content-type** `application/json`

JSON path                    | description
-----------------------------|-------------------------------
`success`                    | true/false, успешность операции
`reason`                     | причина того, что бронирование не было создано
`order.pnr_number`           | номер бронирования
`order.prices.total`         | всего к оплате, в рублях
`order.prices.fare`          | тарифы авиакомпании, в сумме
`order.prices.tax_and_markup`| налоги и сборы
`order.prices.discount`      |
`order.prices.fee`           |
`order.rules`                | правила тарифа
`errors`                     | ошибки валидации

расшифровка `reason`

* `"unable_to_sell"` забронировать невозможно по внешним (не связанным с данными запроса) причинам.
* `"price_changed"` цена данного предложения изменилась, необходимо подтвердить новую цену (нужно послать точно такой же запрос еще один раз), дополнительная информация в поле info
* `"invalid_data"` данные в запросе не валидны, дополнительная информация в поле errors

