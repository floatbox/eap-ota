Три вида нотификаций

1. Ваш заказ
  order_notice

2. Ваш билет
  ticket_notice

3. Ваше бронирование
  booking_notice

Алгоритм

При создании ордера ставится delayed_job задача через 10 минут сформировать нотис.
При создании нотиса проверяется статус ордера и выставляется нужный формат письма. 
Нотис отправляется либо отдельным delayed_job либо по хрону.
Ордеру выставляется статус ticket_sent если ушел тикет.


- - -

Использование поля Order.email_status
для отслеживания статуса нотификаций по ордеру

Сейчас
'' - готов к отправке нотификаций
'queued' - нотификация поставлена в очередь
'not ready' - амедеусовские ордеры изначально не готовы, потом из Strategy (lib/strategy/amadeus/booking.rb) выставляется ''

Надо
'not_ready'
'' - готов к отправке
'queued'
'order_sent'
'booking_sent'
'ticket_sent'

- - -

Сценарии

1. Заказ на сайте
	текст

2. Бронирование на сайте
	текст + пнр

3. Тикетирование заказа
	пнр

4. Письмо из админки с бронью

5. Письмо из админки с тикетом

6. Письмо из админки с соментом без ПНР


- - -

oo.notifications.new.create_booking_notice
oo.notifications.new.create_ticket_notice

Нотификации создаются из модели Order колбеком after_save метод create_notification

Там в зависимотсти от статусов Ордера дергается self.notifications.new.create_pnr

В методе create_pnr модели Notification создается запись в таблице notifications
с данными о нотификации.

Шедуллер запускает Notification.process_queued_emails! каждые 5 минут.
Здесь выпираются все неотосланные записи ои таблицы по 50 штук, и для каждой дергается метод send_email.

Метод send_email вызывает PnrMailer.notice(self).deliver
и выставляет статусы нотификации :status => 'sent', 'sent_at' => Time.now

PnrMailer.notice собирате данные для генерации письма и рендерит нужный шаблон
'pnr/ticket' или 'pnr/booking' в зафисимотси от формата.
Если в нотификации есть текст notification.comment этот тектст подставляется в письмо.
Отрендеренный текст письма сохраняется в базе notification.rendered_message.


Двухэтапные письма бронь-тикет

	booking_notice \\ order_notice
	1. при бронировани приходит письмо:
Subj: Ваш заказ [PNR].

Body:
Здравствуйте!

Спасибо за заказ. Номер вашего заказа — [PNR]. Ваши авиабилеты буду выписаны в течение X часов и высланы вам отдельным письмом на этот же электронный адрес.

Если у вас возникнут какие-либо вопросы, вы можете просто ответить на это письмо. Просьба цитировать номер заказа в письме.

Также вы можете позвонить нам по телефону +7 495 660-35-20. Операторы работают с десяти утра до девяти вечера по московскому времени.

--
Спасибо, что воспользовались нашим сервисом.
Команда Eviterra.com


	ticket_notice
	2. при тикетировании приходит письмо с тикетом
Subj: Ваш электронный билет (заказ [PNR])

Body:
[маршрутка]



Дополнительные нотификации

	3. visa_notice
	Требование визы

	4. reminder
	Напоминание о вылете и онлайновой регистрации за 36 часов до вылета