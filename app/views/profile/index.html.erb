<% content_for :title do %>Личный кабинет<% end %>

<h2 class="page-title"><%= current_customer.email %><%#= current_customer.confirmed? %></h2>

<%#= link_to "Change your password", edit_customer_registration_path %>

<ul class="profile-menu">
    <li class="pm-item">Заказы</li>
    <li class="pm-item">Пассажиры</li>
    <li class="pm-item">Подписки</li>
</ul>

<%#= debug @orders.first %>

<table id="personal-orders">
<thead class="po-header">
<tr>
    <th>номер</th>
    <th>дата</th>
    <th>маршрут</th>
    <th>вылет</th>
    <th>статус</th>
    <th style="text-align: right;">стоимость</th>
</tr>
</thead>
<% @orders.each do |order| %>
<tbody class="po-row">
<tr>
    <td><%= order.pnr_number %></td>
    <td><%= l(order.created_at, :format => :human_year) %></td>
    <td><%= order.profile_route_smart %> <br><small><%= order.profile_route %></small></td>
    <td><%= l(order.departure_date, :format => :human_year) %></td>
    <td><%= order.profile_status %></td>
    <td style="text-align: right;"><%= decorate_price short_price(order.profile_payment_price) %></td>
</tr>
<tr class="po-details pod-hidden">
    <td colspan="6" class="pod-cell">
    <div class="pod-wrapper">
        <div class="pod-content">
        <% if order.profile_ticketed? %>
          <% order.tickets.each do |ticket| %>
            <div class="pod-passenger">
              <h6 class="pod-name"><%= ticket.profile_name %></h6>
              <p class="pod-ticket">билет <%= ticket.carrier %> <%= ticket.number %></p>
              <p class="pod-ticket">&nbsp;-&nbsp;</p>
              <p class="pod-ticket"><%= ticket.profile_status %></p>
              <% if ticket.flights.present? %>
                <p class="pod-ticket">&nbsp;-&nbsp;</p>
                <p class="pod-ticket"><a href="<%= profile_show_pnr_for_ticket_path(:id => order.pnr_number, :ticket_id => ticket.id) %>" target="_blank">билет</a></p>
              <% end %>
              </div>
          <% end %>
        <% else %>
          <% order.profile_people.each do |person| %>
            <div class="pod-passenger">
              <h6 class="pod-name"><%= person[:name] %></h6>
              <p class="pod-ticket"><%= person[:status] %></p>
            </div>
          <% end %>
        <% end %>
          <div class="pod-pnr"><a href="<%= profile_show_pnr_path(:id => order.pnr_number) %>" target="_blank">Маршрут квитанция</a></div>
        </div>
    </div>

    <% if admin_user %>
    <div class="po-debug">
        статус <%= order.profile_status %>
    </div>
    <% end %>

    </td>
</tr>
</tbody>
<% end %>
</table>
<script type="text/javascript">
var ordersTable = {
init: function() {
    var that = this;
    this.el = $('#personal-orders');
    this.el.on('click', '.po-row:not(.po-selected)', function() {
        var selected = that.el.find('.po-selected');
        if (selected.length) {
            that.hide(selected);
        }
        that.show($(this));
    });
},
show: function(row) {
    row.addClass('po-selected');
    row.find('.po-details').removeClass('pod-hidden');
    row.find('.pod-wrapper').slideDown(150);
},
hide: function(row) {
    row.removeClass('po-selected').addClass('po-previous');
    row.find('.pod-wrapper').slideUp(150, function() {
        row.find('.po-details').addClass('pod-hidden');
        row.removeClass('po-previous');
    });
}
};
ordersTable.init();
</script>
